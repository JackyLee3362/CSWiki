## 5.3 TCP协议(Transmission Control Protocol, 传输控制协议)

### TCP协议的特点
- 可靠性：可靠
- 单位：报文段
### TCP报文段
- 源端口 和 目的端口，各占2B
- 序号，占4B
- 确认号，占4B
- 数据偏移（即首部长度），占4位，单位是4B（和下面的填充呼应），最大1111表示15⇒60B
- 保留
- 紧急位 URG
- 确认位 ACK
- 推送位 PSH（Push）
- 复位位 RST（Reset）
- 同步位 SYN
- 终止位 FIN（Finish）
- 窗口，占2B
- 校验和（伪首部协议字段为4，UDP为17），占2B
- 紧急指针，占2B
- 选项 MSS，长度可变
- 填充，长度可变，为了使整个首部长度是4B的整数倍
### TCP连接管理
- TCP连接的建立 数据传送 连接释放
- 采用 客户 / 服务器 方式
- 连接的建立——三次握手
    - 客户机：`SYN = 1, seq = x`  
    - 服务器：`SYN = 1, ACK = 1, seq = y, ack = x + 1`
    - 客户机：`ACK = 1, seq = x + 1, ack = y + 1`
- 连接的释放——四次握手
    - 客户机：`FIN = 1, seq = u`
    - 服务器：`ACK = 1, seq = v, ack = u + 1`
    - （服务器可能又发送了一段数据）
    - 服务器：`FIN = 1, seq = w, ack = u + 1`
    - 客户机：`ACK = 1, seq = u + 1, ack = w + 1` 
### TCP可靠传输
- 序号
- 确认
- 累计确认
- 重传
    - 超时
        - RTTS：加权平均往返时间
        - 超时重传时间RTO
    - 冗余ACK
### TCP流量控制
- 接收窗口 rwtd
- 拥塞窗口 cwtd
- 传输层和数据链路层流量控制的区别
    - 传输层定义端到端，数据链路层定义点到点
    - 传输层滑动窗口可以动态变化，数据链路层不行
### TCP拥塞控制
- 发送窗口的上限值 = min[rwnd, cwnd]
- 慢开始
    - 慢开始门限 / 慢开始阈值 ssthresh
    - cwnd < ssthresh
    - t = 0时， cwnd = 1
- 拥塞避免
    - cwnd > or = ssthresh
- 快重传
    - 冗余ACK
    - 当发送方连续收到三个重复的ACK报文时，直接重传对方尚未收到的报文，而不必等待那个报文段设置的重传计时器
- 快恢复：
### 习题
- 4 【2014】 主机甲和乙建立了TCP连接，甲始终以 MSS = 1KB 大小的段发送数据，并一直有数据发送；乙每收到一个数据段都会发出一个接收窗口为 10KB 的确认段。若甲在 t 时刻发生超时的时候拥塞窗口为 8KB，则从 t 时刻起，不再发生超时的情况下，经过10个RTT后，甲的发送窗口是→10KB
- 18 A 和 B 之间建立了TCP连接，A向B发送了一个报文段，其中序号字段是 seq = 200，确认字号段 ack = 201，数据部分有两个字节，那么在B对该报文得确认报文段中 seq 和 ack 分别是多少答案→201，202
- 21 在一个TCP连接中，MSS为1KB，当拥塞窗口为34KB时发生了超时事件，如果在接下来得4个RTT内报文段传输都是成功得，那么当这些报文段均得到确认后，拥塞窗口的大小是?→16KB
- 22 设TCP的拥塞窗口的慢开始门限值初始为8（单位为报文段），当拥塞窗口上升到12时发生超时，TCP开始慢启动和拥塞避免，那么第13次传输时拥塞窗口的大小为多少→7
- 23 在一个TCP连接中，MSS为1KB，当拥塞窗口为34KB时收到了3个冗余ACK报文，如果在接下来得4个RTT内报文段传输都是成功得，那么当这些报文段均得到确认后，拥塞窗口的大小是，答案→21KB
- 26【2009】主机甲和乙建立了TCP连接，主机甲向主机乙发送了两个连续的TCP段，分别包含300B和500B的有效载荷，第一个段的序列号为200，主机乙正确接收到这两个数据段后，发送给主机甲的确认序列号是→500
- 27 【2009】主机甲和乙建立了TCP连接，主机甲向主机乙发送了两个连续的TCP段，分别包含300B 和 500B 的有效载荷，第一个段的序列号为200，主机乙正确接收到这两个数据段后，发送给主机甲的确认序列号是→500
- 28【2010】主机甲和乙建立了TCP连接，TCP最大段长为1000B。若主机甲当前拥塞窗口为4000B，在主机甲向主机乙连续发送两个最大段后，成功收到主机乙发送的第一个段的确认段，确认段中通告的接收窗口大小为2000B，则此时主机甲还可以向主机乙发送的最大字节数为，答案→1000B
- 29【2011】主机甲向主机乙发送一个（SYN = 1, seq = 11220）的TCP段，期望与主机乙建立TCP连接，若主机乙接受该连接请求，则主机乙向主机甲发送正确的TCP段可能是→SYN = 1, ACK = 1, seq = 11221, ack = 11221
- 30【2011】主机甲和乙建立了TCP连接，主机甲向主机乙发送了3个连续的TCP段，分别包含300B、400B和500B的有效载荷，第3个段的序号是900。若主机乙仅正确接收到第1个段和第3个段，则主机乙发送给主机甲的确认序号是→500
- 31【2013】主机甲和乙建立了TCP连接，双方持续有数据传输，且数据无差错与丢失。若甲收到一个来自乙的TCP段，该段的序号为1913、确认序号为2046、有效载荷为100B，则甲立即发送给乙的TCP段的序号和确认序号是→2046, 2013
- 33【2015】
- 34【2017】若甲向乙新建了一个TCP连接，甲的拥塞控制初始阈值为 32KB，甲向乙始终以MSS = 1 KB大小的段发送数据，并一直有数据发送；乙为该连接分配16KB接收缓存，并对每隔数据段进行确认，忽略段传输延迟。若乙收到的数据全部存入缓存，不被取走，则甲从连接建立成功时刻起，未出现发送超时的情况下，经过4个RTT后，甲的发送窗口是→1KB
- 35【2019】
- 36【2019】若主机甲主动发起一个与主机乙的TCP的连接，甲、乙选择的初始序列号分别为 2018 和 2046，则第三次握手TCP段的确认序号是→2047
- 37【2020】若主机甲和主机乙建立一条TCP连接，最大段长（MSS）为1KB，往返时间（RTT）为 2ms，则不出现拥塞的前提下，拥塞窗口从8KB增长到32KB所需的最长时间是→48ms
- 38【2020】主机甲和乙建立了TCP连接时，发送的SYN段中的序号为1000，在断开连接时，甲发送给乙的FIN段中的序号为5001，则在无任何重传的情况下，甲向乙已经发送的应用层数据的字节数为→4000
- 综合题5 当前 RTT = 35ms，另外收到三个确认报文段的滞后时间分别是 27ms 30ms 21ms ，设α=0.2，求新的RTT值 ?→30.4ms
- 综合题15 【2012】47
① 表1中的IP分组，哪几个是由H发送的？哪几个完成了TCP连接建立过程？哪几个在通过快速以太网传输时进行了填充
② 根据表1中的IP分组，分析S已经收到的应用层数据字节数是多少？
③ 若表1中的某个IP分组在S发出时的前40B如表2所示，则该IP分组到达H时经过了多少个路由器？→看PDF
- 综合题16【2016】34→看PDF
