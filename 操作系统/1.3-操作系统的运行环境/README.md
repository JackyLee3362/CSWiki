## 1.3 操作系统的运行环境

### 操作系统的运行机制

- 程序分类
  - 内核程序：执行特权指令
    - 特权指令：指计算机中不允许被用户直接使用的指令
  - 应用程序
    - 非特权指令：应用程序可以使用的指令
    -
  - 内核程序 是 应用程序 的管理程序
- CPU 状态
  - 用户态 / 目态 user mode
    - 可以在用户态下执行的指令 ↓
      - 读时钟指令（置时钟不行）
      - 取数指令
      - 寄存器清零指令
      - 算术运算
      - 访管指令
        - 访管中断
          - **访管指令**是一条可以在**用户态**下执行的指令。在用户程序中，因要求操作系统提供服务而有意识地使用访管中断，从而产生一个中断事件（自愿中断），将操作系统转换为**核心态**，称为访管中断
  - 核心态
    - [Aliases](./~/Aliases.md) #Aliases #Aliases ↓
      1. Kernel Mode
      2. 管态
      3. 内核态
    - 只能在核心态执行的指令―输入/输出指令 系统调用（广义指令）
  - CPU 状态之间的转换
    - 用户态 —> 内核态―中断、异常、访管指令
    - 内核态 —> 用户态―设置程序状态字
- 大多数操作系统的内核分为 4 方面内容
  - 时钟管理
  - 中断机制
  - 原语 Atomic Operation
    - 处于操作系统的最底层，是最接近硬件的部分
    - 这些程序的运行具有原子性，其操作只能一气呵成（主要从系统安全性和便于管理考虑）
    - 这些程序的运行时间较短
  - 系统控制的数据结构及处理
    - 进程管理：进程状态管理、进程调度和分配、创建与撤销进程控制块等
    - 存储器管理：存储器的空间分配和回收、内存信息保护程序、代码对换程序等
    - 设备管理：缓冲区管理、设备分配和回收等
-

### 中断和异常的概念

- 中断和异常的定义
  - 中断（Interruption）也称外中断，指来自 CPU 执行指令以外的事件的发生，如设备发出的 I/O 结束中断或时钟中断
  - 异常（Exception）也称内中断、例外或陷入（trap），指源自 CPU 执行指令内部的事件，如程序的非法操作码、地址越界、算术溢出、虚存系统的缺页及专门的陷入指令，比如访管指令
- 中断处理的过程 ↓
  1. 关中断
  2. 保存断点：程序计数器 PC
  3. 中断服务程序寻址：程序状态字寄存器 PSWR
  4. 保存现场和屏蔽字
  5. 开中断
  6. 执行中断程序服务
  7. 关中断
  8. 恢复现场和屏蔽字
  9. 开中断、中断返回
  - 1-3 步是在 CPU 进入中断周期后，由硬件自动（中断隐指令）完成
  - 4-9 步由中断服务程序完成
- 系统调用
- 设备管理
- 文件管理
- 进程控制
- 进程通信
- 内存管理

### 习题

- 2 下列说法正确的是
  ① 批处理的主要缺点是需要大量内存
  ② 当计算机提供了核心态和用户态时，输入/输出指令必须在核心态下执行
  ③ 操作系统中多采用多道程序设计技术的主要原因是提高 CPU 和外部设备的可靠性
  ④ 操作系统中，通道技术是一种硬件技术 →②④，① 错误：批处理的主要缺点是缺少交互性；② 正确：输入/输出指令需要中断操作，中断必须在核心态下执行；③ 错误：多道性是为了提高操作系统利用率和吞吐量而提出的；④ 正确：I/O 通道实际上是一种特殊的处理器，它具有执行 I/O 指令的能力，并通过执行通道程序来控制 I/O 操作 - 通道技术 - 通道是一个独立于 CPU 的专管 I/O 控制的处理机，它控制设备与内存直接进行数据交换 - 通道是独立于中央处理器的，专门负责数据 I/O 传输工作的理单元 - 代替 CPU 对 I/O 操作进行控制，从而使 CPU 和外部设备可以并行工作。所以通道又称为 I/O 处理机。 - 引入通道的目的是:使数据的传输独立于 CPU,使 CPU 从繁重的 I/O 工作中解脱出来. 它有自己的通道指令，这些通道指令受 CPU 启动，并在操作结束时向 CPU 发中断信号 - 通道方式进一步减轻了 CPU 的工作负担，增加了计算机系统的并行工作程度。
- 10【2011】下列选项中，在用户态执行的是
  A 命令解释程序
  B 缺页处理程序
  C 进程调度程序
  D 时钟中断处理程序 →A，进程调度是操作系统内核进程，无须用户干预，在核心态执行
- 11【2012】下列选项中，不可能在用户态发生的事件是
  A 系统调用
  B 外部中断
  C 进程切换
  D 缺页 →C
- 18【2013】
- 20 中断处理 和 子程序调用 都需要 压栈以保护现场，中断处理一定会保存而子程序调用不需要保存其内容的是
  A 程序计数器
  B 程序状态字寄存器
  C 通用数据寄存器
  D 通用地址寄存器 →B
- 24【2015】 处理外部中断时，应该由操作系统保存的是
  A 程序计数器的内容
  B 通用寄存器的内容
  C 块表（TLB）中的内容
  D Cache 中的内容 →B，外部中断处理过程中，PC 值由中断隐指令自动保存
- 25【2015】 假定下列指令已经装入指令寄存器，则执行时不可能导致 CPU 从用户态变为内核态的是
  A DIV R0, R1; (R0)/(R1)—>R0
  B INT n; 产生软中断
  C NOT R0; 寄存器 R0 的内容取非
  D MOV R0, addr; 把地址 addr 处的内存数据放入寄存器 R0
  答案 →C，A 有除零异常的可能，B 为中断指令，指令 D 有缺页异常的可能
- 26【2017】执行系统调用的过程包括如下主要操作
  ① 返回用户态
  ② 执行陷入（trap）指令
  ③ 传递系统调用参数
  ④ 执行相应的服务程序 →③②④①
- 27【2018】 定时器产生时钟中断后，由时钟中断服务程序更新的部分内容是
  ① 内核中时钟变量的值
  ② 当前进程占用 CPU 的时间
  ③ 当前进程在时间篇内的剩余执行时间 →①②③
- 28【2015】 下列关于系统调用的叙述中，正确的是
  ① 在执行系统调用服务程序的过程中，CPU 处于内核态
  ② 操作系统通过系统调用避免用户直接访问外设
  ③ 不同的操作系统为应用程序提供了统一的系统调用接口
  ④ 系统调用是操作系统内核为应用程序提供服务的接口?→①②④
- 29 下列与中断相关的操作中，由操作系统完成的是
  ① 保存被中断程序的中断点
  ② 提供中断服务
  ③ 初始化中断向量表
  ④ 保存中断屏蔽字?→②③④
